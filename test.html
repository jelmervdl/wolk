<script src="compat.js"></script>
<script src="wolk.js"></script>
<script>

window.x = new Storage('test');

var _api_key = function() {
	return localStorage['__api_key'];
}

var _api_url = function() {
	return localStorage['__api_url'];
}

var _load = function() {
	document.getElementById('api_key').value = localStorage['__api_key'] || '';
	document.getElementById('api_url').value = localStorage['__api_url'] || document.location.href.replace('test.html', 'sync.php');
	
	_fill_table(document.getElementById('pairs'));
}

var _apply = function() {
	localStorage['__api_key'] = document.getElementById('api_key').value;
	localStorage['__api_url'] = document.getElementById('api_url').value;
}

var _sync = function() {
	var forceComplete = document.getElementById('force_complete').checked;
	console.log(forceComplete, x.synchronize(forceComplete));
}

var _fill_table = function(table) {
	var data = x.find();
	
	for (var key in data)
	{
		var td_key = document.createElement('td');
			td_key.appendChild(document.createTextNode(key));
		var input_value = document.createElement('input');
			input_value.type = 'text';
			input_value.value = data[key];
		var td_value = document.createElement('td');
			td_value.appendChild(input_value);
		
		x.connect(key, function(value) {
			this.value = value;
		}.bind(input_value));
		
		input_value.addEventListener('change', (function(key) {
			x.set(key, this.value);
		}).bind(input_value, key), false);
		
		var tr = document.createElement('tr');
			tr.appendChild(td_key);
			tr.appendChild(td_value);
		
		table.appendChild(tr);
	}
}

window.onload = _load;

</script>
<style>
	.prefs input {
		float: left;
		width: 300px;
	}
	
	.prefs label {
		float: left;
		width: 150px;
		text-align: right;
		padding-right: 10px;
	}
	
	.prefs input, .prefs label {
		font: 16px/20px Helvetica;
	}
	
	br {
		clear: both;
	}
</style>
<section>
	<fieldset class="prefs">
		<legend>Sync Preferences</legend>
		<label for="api_key">API Key</label>
		<input type="text" id="api_key">
		<br>
		<label for="api_url">API URL</label>
		<input type="text" id="api_url">
		<br>
		<button onclick="_apply()">Apply</button>
		<button onclick="_load()">Cancel</button>
	</fieldset>
	<fieldset>
		<button onclick="_sync()">Storage.synchronize()</button>
		<input type="checkbox" id="force_complete">
		<label for="force_complete">Force Complete Sync</label>
	</fieldset>
	<table id="pairs"></table>
</section>
